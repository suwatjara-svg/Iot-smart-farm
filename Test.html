<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>คำนวณระบบสปริงเกอร์ Smart Farm</title>
<style>
    body{
        font-family: "Sarabun","Segoe UI",Tahoma,sans-serif;
        background:#f4f6f8;
        margin:0;
        padding:20px;
    }
    .container{
        max-width:1000px;
        margin:auto;
        background:#fff;
        padding:20px;
        border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    h1{
        text-align:center;
        color:#0d47a1;
    }
    h2{
        color:#0d47a1;
        border-left:6px solid #1976d2;
        padding-left:10px;
        margin-top:25px;
    }
    label{
        font-weight:bold;
    }
    input,select{
        width:100%;
        padding:8px;
        margin-top:4px;
        margin-bottom:10px;
        border-radius:6px;
        border:1px solid #ccc;
        box-sizing:border-box;
    }
    .row{
        display:flex;
        gap:15px;
    }
    .col{
        flex:1;
    }
    button{
        padding:10px 16px;
        border:none;
        border-radius:6px;
        cursor:pointer;
        font-size:16px;
    }
    #addZoneBtn{
        background:#4caf50;
        color:white;
        margin-top:10px;
    }
    #calcBtn{
        background:#0d47a1;
        color:white;
        width:100%;
        margin-top:15px;
    }
    table{
        width:100%;
        border-collapse:collapse;
        margin-top:15px;
        font-size:14px;
    }
    th,td{
        border:1px solid #ccc;
        padding:6px 8px;
        text-align:center;
    }
    th{
        background:#e3f2fd;
    }
    .zone-card{
        border:1px solid #ddd;
        padding:10px;
        border-radius:8px;
        margin-top:10px;
        background:#fafafa;
    }
    .small{
        font-size:12px;
        color:#555;
    }
</style>
</head>
<body>
<div class="container">
    <h1>คำนวณระบบสปริงเกอร์ Smart Farm</h1>

    <!-- ข้อมูลปั๊มน้ำ -->
    <h2>1) ข้อมูลปั๊มน้ำ</h2>
    <div class="row">
        <div class="col">
            <label>อัตราการไหลสูงสุดของปั๊ม (L/min)</label>
            <input type="number" id="pumpFlowMax" placeholder="เช่น 200">
        </div>
        <div class="col">
            <label>แรงดันสูงสุดของปั๊ม (m)</label>
            <input type="number" id="pumpHeadMax" placeholder="เช่น 30">
        </div>
        <div class="col">
            <label>ขนาดท่อออกจากปั๊ม</label>
            <select id="pumpPipeSize">
                <option value="0.5">1/2 นิ้ว</option>
                <option value="0.75">3/4 นิ้ว</option>
                <option value="1">1 นิ้ว</option>
                <option value="1.25">1 1/4 นิ้ว</option>
                <option value="1.5">1 1/2 นิ้ว</option>
                <option value="2">2 นิ้ว</option>
                <option value="2.5">2 1/2 นิ้ว</option>
                <option value="3">3 นิ้ว</option>
            </select>
        </div>
    </div>

    <!-- Margin -->
    <label>เผื่อ Margin ความปลอดภัย (%)</label>
    <select id="safetyMargin">
        <option value="0.10">10%</option>
        <option value="0.15">15%</option>
        <option value="0.20" selected>20%</option>
        <option value="0.25">25%</option>
        <option value="0.30">30%</option>
        <option value="0.40">40%</option>
    </select>

    <!-- โซนสปริงเกอร์ -->
    <h2>2) ข้อมูลโซนสปริงเกอร์ (เพิ่มได้หลายโซน)</h2>
    <div id="zonesContainer"></div>
    <button id="addZoneBtn" type="button" onclick="addZone()">+ เพิ่มโซน</button>

    <button id="calcBtn" type="button" onclick="calculate()">คำนวณทั้งหมด</button>

    <!-- ผลลัพธ์ -->
    <h2>3) ผลลัพธ์</h2>
    <div id="summary"></div>
    <div id="zoneTableContainer"></div>
</div>

<script>
// ตารางเส้นผ่านศูนย์กลางท่อโดยประมาณ (มม.)
const pipeDiameter = {
    0.5: 15,
    0.75: 20,
    1: 25,
    1.25: 32,
    1.5: 40,
    2: 50,
    2.5: 63,
    3: 75
};

// ค่าสัมประสิทธิ์ Hazen-Williams สำหรับท่อ PVC
const C_HW = 140;

let zoneIndex = 0;

function addZone(){
    zoneIndex++;
    const container = document.getElementById('zonesContainer');
    const div = document.createElement('div');
    div.className = 'zone-card';
    div.dataset.zoneIndex = zoneIndex;

    div.innerHTML = `
        <h3>โซนที่ ${zoneIndex}</h3>
        <div class="row">
            <div class="col">
                <label>ชื่อโซน</label>
                <input type="text" id="zoneName_${zoneIndex}" placeholder="เช่น แปลงผัก A">
            </div>
            <div class="col">
                <label>จำนวนหัวสปริงเกอร์ในโซน</label>
                <input type="number" id="heads_${zoneIndex}" placeholder="เช่น 5">
            </div>
            <div class="col">
                <label>อัตราการไหลต่อหัว (L/h)</label>
                <input type="number" id="flowPerHead_${zoneIndex}" placeholder="เช่น 350">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>แรงดันที่หัวต้องการ (bar)</label>
                <input type="number" id="pressureRequired_${zoneIndex}" placeholder="เช่น 1.5">
            </div>
            <div class="col">
                <label>ขนาดท่อของโซน</label>
                <select id="zonePipeSize_${zoneIndex}">
                    <option value="0.5">1/2 นิ้ว</option>
                    <option value="0.75">3/4 นิ้ว</option>
                    <option value="1">1 นิ้ว</option>
                    <option value="1.25">1 1/4 นิ้ว</option>
                    <option value="1.5">1 1/2 นิ้ว</option>
                    <option value="2">2 นิ้ว</option>
                    <option value="2.5">2 1/2 นิ้ว</option>
                    <option value="3">3 นิ้ว</option>
                </select>
            </div>
            <div class="col">
                <label>ความยาวท่อของโซน (m)</label>
                <input type="number" id="pipeLength_${zoneIndex}" placeholder="เช่น 40">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>จำนวนข้องอ/วาล์ว/ข้อต่อ</label>
                <input type="number" id="fittings_${zoneIndex}" placeholder="เช่น 8">
            </div>
            <div class="col">
                <label>ความสูงต่างระดับ (m)</label>
                <input type="number" id="heightDiff_${zoneIndex}" placeholder="เช่น 2">
            </div>
        </div>
        <p class="small">* ใช้สูตร Hazen-Williams ประมาณการ head loss ในท่อ และ minor loss จากข้องอ</p>
    `;
    container.appendChild(div);
}

// Hazen-Williams
function hazenWilliamsHeadLoss(Q, d, L){
    if(Q <= 0 || d <= 0 || L <= 0) return 0;
    return 10.67 * L * Math.pow(Q, 1.852) /
           (Math.pow(C_HW, 1.852) * Math.pow(d, 4.87));
}

// Minor loss
function minorLoss(v, fittings){
    const g = 9.81;
    const K_each = 0.5;
    return fittings * K_each * v * v / (2 * g);
}

function calculate(){
    const pumpFlowMax = parseFloat(document.getElementById('pumpFlowMax').value) || 0;
    const pumpHeadMax = parseFloat(document.getElementById('pumpHeadMax').value) || 0;
    const safetyMargin = parseFloat(document.getElementById('safetyMargin').value);

    let zones = [];

    for(let i=1;i<=zoneIndex;i++){
        const nameEl = document.getElementById(`zoneName_${i}`);
        if(!nameEl) continue;

        const name = nameEl.value || `โซนที่ ${i}`;
        const heads = parseFloat(document.getElementById(`heads_${i}`).value) || 0;
        const flowPerHead = parseFloat(document.getElementById(`flowPerHead_${i}`).value) || 0;
        const pressureRequiredBar = parseFloat(document.getElementById(`pressureRequired_${i}`).value) || 0;
        const zonePipeSize = parseFloat(document.getElementById(`zonePipeSize_${i}`).value) || 0.5;
        const pipeLength = parseFloat(document.getElementById(`pipeLength_${i}`).value) || 0;
        const fittings = parseFloat(document.getElementById(`fittings_${i}`).value) || 0;
        const heightDiff = parseFloat(document.getElementById(`heightDiff_${i}`).value) || 0;

        const Q_Lh = heads * flowPerHead;
        const Q_Lmin = Q_Lh / 60;
        const Q_m3s = Q_Lmin / 1000 / 60;

        const D_mm = pipeDiameter[zonePipeSize];
        const D_m = D_mm / 1000;
        const area = Math.PI * Math.pow(D_m/2,2);
        const v = Q_m3s / area;

        const hf_pipe = hazenWilliamsHeadLoss(Q_m3s, D_m, pipeLength);
        const hf_minor = minorLoss(v, fittings);

        const hf_total = (hf_pipe + hf_minor + heightDiff) * (1 + safetyMargin);

        const headAtSprinklerReq = pressureRequiredBar * 10;
        const headRequiredPump = headAtSprinklerReq + hf_total;

        let headAtSprinklerActual = pumpHeadMax - hf_total;
        if(headAtSprinklerActual < 0) headAtSprinklerActual = 0;

        const pressureAtSprinklerBar = headAtSprinklerActual / 10;

        const pumpFlowEnough = pumpFlowMax >= Q_Lmin;
        const pumpHeadEnough = pumpHeadMax >= headRequiredPump;
        const pumpOk = pumpFlowEnough && pumpHeadEnough;

        zones.push({
            name,
            Q_Lmin,
            v,
            hf_pipe,
            hf_minor,
            hf_total,
            pressureAtSprinklerBar,
            pumpOk
        });
    }

    renderSummary(pumpFlowMax,pumpHeadMax,zones);
    renderZoneTable(zones);
}

function renderSummary(pumpFlowMax,pumpHeadMax,zones){
    const totalFlow = zones.reduce((sum,z)=>sum+z.Q_Lmin,0);
    const summaryDiv = document.getElementById('summary');

    summaryDiv.innerHTML = `
        <p><b>อัตราการไหลรวมเมื่อเปิดทุกโซนพร้อมกัน:</b> ${totalFlow.toFixed(2)} L/min</p>
        <p><b>แรงดันสูงสุดของปั๊ม:</b> ${pumpHeadMax.toFixed(2)} m</p>
        <p class="small">* มีการเผื่อ Margin ความปลอดภัยตามที่เลือก</p>
    `;
}

function renderZoneTable(zones){
    const container = document.getElementById('zoneTableContainer');
    if(zones.length === 0){
        container.innerHTML = "<p>ยังไม่มีข้อมูลโซน</p>";
        return;
    }

    let html = `
    <table>
        <thead>
            <tr>
                <th>โซน</th>
                <th>Q รวม (L/min)</th>
                <th>ความเร็ว (m/s)</th>
                <th>Head loss ท่อ (m)</th>
                <th>Head loss ข้องอ (m)</th>
                <th>Head loss รวม + Margin (m)</th>
                <th>แรงดันที่หัว (bar)</th>
                <th>ปั๊มเพียงพอหรือไม่</th>
            </tr>
        </thead>
        <tbody>
    `;

    zones.forEach(z=>{
        html += `
        <tr>
            <td>${z.name}</td>
            <td>${z.Q_Lmin.toFixed(2)}</td>
            <td>${z.v.toFixed(2)}</td>
            <td>${z.hf_pipe.toFixed(2)}</td>
            <td>${z.hf_minor.toFixed(2)}</td>
            <td>${z.hf_total.toFixed(2)}</td>
            <td>${z.pressureAtSprinklerBar.toFixed(2)}</td>
            <td>${z.pumpOk ? "✔ Yes" : "❌ No"}</td>
        </tr>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}
</script>
</body>
</html>